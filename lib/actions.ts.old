// lib/actions.ts
import { db } from './firebase';
import { doc, runTransaction, arrayUnion, arrayRemove } from 'firebase/firestore';

const VPE_EMAIL = process.env.NEXT_PUBLIC_VPE_EMAIL;

export const reserveRole = async (meetingId: string, slotIndex: number, user: any, roleName: string) => {
  const meetingRef = doc(db, "meetings", meetingId);
  const userRef = doc(db, "users", user.uid);

  await runTransaction(db, async (transaction) => {
    const meetingSnap = await transaction.get(meetingRef);
    if (!meetingSnap.exists()) throw "Meeting not found";

    const slots = meetingSnap.data().slots;
    
    // Allow VPE to override an existing slot? 
    // Usually better to Cancel first, then Book. 
    // But we check here if the slot is taken.
    if (slots[slotIndex].userId) throw "Slot already taken! Cancel it first.";

    slots[slotIndex].userId = user.uid;
    slots[slotIndex].userName = user.displayName;
    transaction.update(meetingRef, { slots });

    transaction.update(userRef, {
      roleHistory: arrayUnion(roleName)
    });
  });
};

export const cancelRole = async (meetingId: string, slotIndex: number, currentUser: any, roleName: string) => {
  const meetingRef = doc(db, "meetings", meetingId);

  await runTransaction(db, async (transaction) => {
    const meetingSnap = await transaction.get(meetingRef);
    if (!meetingSnap.exists()) throw "Meeting not found";

    const slots = meetingSnap.data().slots;
    const assignedUserId = slots[slotIndex].userId; // The person currently holding the slot

    if (!assignedUserId) throw "Slot is already empty.";

    // PERMISSION CHECK:
    // Allow if: I own the slot OR I am the VPE
    const isOwner = assignedUserId === currentUser.uid;
    const isVPE = currentUser.email === VPE_EMAIL;

    if (!isOwner && !isVPE) {
      throw "You are not authorized to cancel this slot.";
    }

    // 1. Clear the meeting slot
    slots[slotIndex].userId = null;
    slots[slotIndex].userName = "";
    transaction.update(meetingRef, { slots });

    // 2. Clean up the history of the ASSIGNED USER (not necessarily the VPE)
    const assignedUserRef = doc(db, "users", assignedUserId);
    transaction.update(assignedUserRef, {
      roleHistory: arrayRemove(roleName)
    });
  });
};
